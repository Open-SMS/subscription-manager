<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/design_details/subscriber_identification.md at 2023-01-12

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>Subscription Manager &#x2013; Subscriber Identification</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">Subscription Manager
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2023-01-12</span>
           | <span id="projectVersion">Version: 0.0.1-SNAPSHOT</span>
      </div>
      <div class="xright">      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Subscription Manager</h5>
    <ul>
     <li class="none"><a href="../index.html" title="Introduction">Introduction</a></li>
     <li class="none"><a href="../ubiquitous_language.html" title="Ubiquitous Language">Ubiquitous Language</a></li>
     <li class="none"><a href="../design_details/index.html" title="Design Details">Design Details</a></li>
     <li class="none"><a href="../software_development/index.html" title="Software Development">Software Development</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="../project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
       <h5>Test Coverage</h5>
    <ul>
     <li class="none"><a href="../jacoco/index.html" title="Unit Tests">Unit Tests</a></li>
     <li class="none"><a href="../jacoco-it/index.html" title="Integration Tests">Integration Tests</a></li>
     <li class="none"><a href="../jacoco-test-aggregate/index.html" title="Aggregated Tests">Aggregated Tests</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Subscriber Identification</h1>
<p>The requirements for subscriber identification from OIDC Claims are being explored by
<a class="externalLink" href="https://github.com/Open-SMS/subscription-manager/issues/30">Issue #30</a>. The following document contains a summary
of the requirements identified so far, and initial implementation ideas.</p><section>
<h2><a name="Requirements"></a>Requirements</h2>
<p>The claim names that might be included in an authorization request are unknown. It is expected that an RP may forward
all the claims it receives or some arbitrary subset of them. The <code>iss</code> (issuer) and <code>sub</code> (subject) claims should
always be included, although see note about OpenAthens Keystone and <code>sub</code> stability.</p>
<p>The required claim names and associated values required by the system to identify a subscriber are also unknown.
Although standard claim names exist, it is very common for non-standard claim names to be used. The claim names used by
OpenAthens Keystone don't even exist in the IANA registration document.</p>
<p>For example, the claims provided in the authorization request may be:</p>

<div class="source">
<pre><code>{&quot;iss&quot;: &quot;https://free.ac.uk&quot;}
{
  &quot;groups&quot;: [ &quot;staff&quot;, &quot;member&quot; ],
  &quot;sub&quot;: &quot;bKMPRFo6L1ZqYNZ3&quot;,
  &quot;fc-user&quot;: &quot;F+bThf+i0oo8K&quot;
}
</code></pre></div>
<p>and subscriber &#x201c;Free College&#x201d; requires the following for authorization</p>

<div class="source">
<pre><code>iss = &quot;https://free.ac.uk&quot; AND groups = &quot;member&quot;
</code></pre></div>
<p>This would identify the subscriber based on the <code>iss</code> and <code>groups</code> claims presented by the client.</p></section><section>
<h2><a name="Implementation"></a>Implementation</h2>
<p>The problem these requirements present is that identifying the subscriber is not possible with any data model and
simple query that is based upon the claims provided in the authorization request. The code creating the query does not
know that any value of <code>sub</code> would be allowed to identify Free College.</p>
<p>An initial implementation idea might be:</p>
<ul>

<li>Remove claims for all claim names that don't exist in the system.</li>
<li>Perform a query that returns subscribers that match <code>iss</code> and each claim.</li>
<li>Check each remaining subscriber to determine whether the presented claims would meet its authorization requirements.</li>
</ul>
<p>In detail, using the example above this would result in the following actions.</p>
<p>Remove claim with claim name <code>fc-user</code> because it is unknown to the system.</p>
<p>Query subscribers (pseudo SQL)</p>

<div class="source">
<pre><code>SELECT DISTINCT subscriber
FROM subscriber_claim_requirements
WHERE iss = 'https://free.ac.uk' AND claim_name = 'groups' AND claim_value = 'staff'
OR iss = 'https://free.ac.uk' AND claim_name = 'groups' AND claim_value = 'member'
OR iss = 'https://free.ac.uk' AND claim_name = 'sub' AND claim_value = 'bKMPRFo6L1ZqYNZ3'
</code></pre></div>
<p>Filter subscribers by calling a method with the provided claims that returns true if the claims meet its requirements.</p>
<p>The performance of this approach in various scenarios should be considered, along with alternative approaches that
may be more efficient.</p>
<h1>Supporting Information</h1></section><section>
<h2><a name="Standard_Claims"></a>Standard Claims</h2>
<p>Claim names that are a standard part of the OIDC specification.
See <a class="externalLink" href="https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims">Standand Claims</a></p>
<p>It is recommended to use the <code>sub</code> claim to reliably identify a user as recommended by
<a class="externalLink" href="https://openid.net/specs/openid-connect-core-1_0.html#ClaimStability">Claim Stability and Uniqueness</a>.
It is possible that the <code>email</code> claim may be required with caveats about stability and uniqueness.</p></section><section>
<h2><a name="IANA_Registered_Claims"></a>IANA Registered Claims</h2>
<p>Claim names that have been registered with IANA.
See <a class="externalLink" href="https://www.iana.org/assignments/jwt/jwt.xhtml">JSON Web Token Claims</a></p>
<p>I need to look through this list in more detail. It looks like <code>groups</code>, <code>roles</code> and <code>entitlements</code> might be of use.</p></section><section>
<h2><a name="NHS_Care_Identity_Authentication"></a>NHS Care Identity Authentication</h2>
<p>Claims that are supported by NHS Care Identity Authentication.
See <a class="externalLink" href="https://digital.nhs.uk/services/identity-and-access-management/nhs-care-identity-service-2/care-identity-authentication/guidance-for-developers/detailed-guidance/scopes-and-claims">Scopes and Claims</a></p>
<p>The <code>profile</code> scope includes a <code>uid</code> claim, but the documentation indicates that this is identical to <code>sub</code>, so may
not be relevant as an alternative claim.
See <a class="externalLink" href="https://digital.nhs.uk/services/identity-and-access-management/nhs-care-identity-service-2/care-identity-authentication/guidance-for-developers/detailed-guidance/scopes-and-claims#claims">Claims</a></p></section><section>
<h2><a name="Okta_.2F_Auth0"></a>Okta / Auth0</h2>
<p><a class="externalLink" href="https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-token-claims">https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-token-claims</a></p></section><section>
<h2><a name="OpenAthens_Keystone"></a>OpenAthens Keystone</h2>
<p>This is a Shibboleth / OIDC bridge. <a class="externalLink" href="https://docs.openathens.net/providers/what-is-openathens-keystone">See</a>.</p>
<p>The mapping of SAML attributes to OIDC claims is described
<a class="externalLink" href="https://docs.openathens.net/providers/mapping-saml-attributes-to-oidc-claims">here</a>.</p>
<p>Interestingly, they state that <code>sub</code> is &#x201c;a non-persistent user identifier&#x201d;, which conflicts with some of the docs
about claim stability which state that it is a stable identifier.</p>
<p>Derivations of eduPersonScopedAffiliation are provided as <code>derivedEduPersonAffiliation</code> and <code>derivedEduPersonScope</code>
containing just the affiliation and scope respectively.</p>
<p>Claims may be multi-valued, e.g. <code>{ &quot;claimName&quot; : [ &quot;value1&quot;, &quot;value2&quot;] }</code></p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2023<a href="https://github.com/Open-SMS">Open-SMS</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>